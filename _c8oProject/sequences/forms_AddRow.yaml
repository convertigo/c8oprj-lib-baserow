accessibility: Hidden
authenticatedContextRequired: true
comment: |
  '{
      "en": {
          "displayName": "Add or update a row in the no-code database (by matching the form responses)",
          "comment": "Add or update a row in a table. If a column in the table has the same name as the technical ID of a form field, the data will be inserted into that column. If the ''Columns creation'' option is enabled, a column will be created when the technical ID of a form field does not match any column in the form. Form fields can be of any type, but typically, selection lists are mapped to linked columns."
      },
      "fr": {
         "displayName": "Ajouter ou mettre à jour une ligne dans la no-code database (en se calquant sur les réponses du formulaire)",
          "comment": "Ajoutez ou mettez à jour une ligne dans une table. Si une colonne de la table a le même nom que l''ID technique d''un champ du formulaire, la donnée sera insérée dans cette colonne. Si l''option ''Création de colonnes'' est activée, une colonne sera créée quand l''ID technique d''un champ ne correspond à aucune colonne du formulaire. Les champs du formulaire peuvent être de n''importe quel type, mais généralement les listes de sélection sont mappées sur les colonnes liées."
      },
      "es": {
          "displayName": "Agregar o actualizar una fila en la no-code database (coincidiendo con las respuestas del formulario)",
          "comment": "Agregue o actualice una fila en una tabla. Si una columna en la tabla tiene el mismo nombre que el ID técnico de un campo del formulario, los datos se insertarán en esa columna. Si la opción ''Creación de columnas'' está habilitada, se creará una columna cuando el ID técnico de un campo del formulario no coincida con ninguna columna en el formulario. Los campos del formulario pueden ser de cualquier tipo, pero generalmente las listas de selección se asignan a columnas vinculadas."
      },
      "it": {
          "displayName": "Aggiungi o aggiorna una riga in il no-code database (abbinando le risposte del modulo)",
          "comment": "Aggiungi o aggiorna una riga in una tabella. Se una colonna della tabella ha lo stesso nome dell''ID tecnico di un campo del modulo, i dati verranno inseriti in quella colonna. Se l''opzione ''Creazione di colonne'' è abilitata, verrà creata una colonna quando l''ID tecnico di un campo del modulo non corrisponde a nessuna colonna del modulo. I campi del modulo possono essere di qualsiasi tipo, ma generalmente le liste di selezione sono mappate su colonne collegate."
      }
  }'
↓Call_Sequence2 [steps.SequenceStep-1734427992515]: 
  sourceSequence: lib_BaseRow.formscommon_CheckConfig
  ↓forms_config [variables.StepVariable-1734427992518]: 
    description: configure=lib_BaseRow/DisplayObjects/mobile/BrowseTables
    required: true
↓IfError [steps.IfExistStep-1734427992521]: 
  condition: IfError
  sourceDefinition: 
    - xmlizable: 
      - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
      - com.twinsoft.convertigo.beans.common.XMLVector: 
        - java.lang.String: 
          - ↑value: 1734427992515
        - java.lang.String: 
          - ↑value: ./document/error
  ↓Copy [steps.XMLCopyStep-1734427992524]: 
    sourceDefinition: 
      - xmlizable: 
        - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
        - com.twinsoft.convertigo.beans.common.XMLVector: 
          - java.lang.String: 
            - ↑value: 1734427992515
          - java.lang.String: 
            - ↑value: ./document/error
  ↓Return [steps.ReturnStep-1734427992527]: 
↓ParseConfig [steps.SimpleStep-1734427992530]: 
  expression: |
    'jConfig = JSON.parse(forms_config);
    table_id = jConfig.table_id;
    view_id = jConfig.view_id ? jConfig.view_id : null;
    
    // For each column provider in the configuration, compute the lits of fields we wloud like to retriev
    // With the BaseRow API.
    if (jConfig.columns) {
    	include_fields ="";
    	jConfig.columns.forEach(col => include_fields += col +",")
    	include_fields = include_fields.substring(0, include_fields.lastIndexOf('',''));
    }
    
    '
↓Input_variables [steps.InputVariablesStep-1680078354202]: 
↓Call_Sequence1 [steps.SequenceStep-1680262420398]: 
  sourceSequence: lib_BaseRow.FieldsList
  ↓table_id [variables.StepVariable-1680262420400]: 
    comment: Returns only the fields of the table related to the provided value.
    description: table_id
    required: true
    value: 
↓jFields [steps.JsonSourceStep-1680262487884]: 
  comment: Get lits of fields and type from BR Table
  sourceDefinition: 
    - xmlizable: 
      - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
      - com.twinsoft.convertigo.beans.common.XMLVector: 
        - java.lang.String: 
          - ↑value: 1680262420398
        - java.lang.String: 
          - ↑value: ./document/array
  variableName: jFields
↓PrepareData [steps.SimpleStep-1680084166698]: 
  comment: Prepare data to submit according to BR field type
  expression: |
    '// convert XML to JSON doc
    var jDoc = JSON.parse('''' + com.twinsoft.convertigo.engine.util.XMLUtils.XmlToJson(doc, true, true));
    
    var columnToBeCreated = [];
    data = {}
    debugger;
    for (var key in jDoc.variable.resp) {
    	if(typeof jDoc.variable.resp[key].value != "string" && jDoc.variable.resp[key].value == null && jDoc.variable.resp[key].type != null){
    		switch(jDoc.variable.resp[key].type){
    			case "checkbox":
    				var children = jDoc.variable.resp[key].children;
    				var val = "";
    				for(var child of children){
    					if(child.selected){
    						val += child.value + ", "
    					}
    				}
    				if(val.length > 0){
    					val = val.substring(0, val.length -2);
    				}
    				jDoc.variable.resp[key].value = val;
    				break;
    		}
    	}
    	log.warn("** Key is : [" + key + "] value is : " + jDoc.variable.resp[key].value)
    	
    	var obj  = jFields.find((object) => object.name === key )
    	var type = obj ? obj.type : null
    	
    	log.warn("** type is : " + type)
    	switch (type) {
    		case ''text'':
    		case ''long_text'':
    		case ''number'':
    		case ''date'':
    		case ''boolean'':
    		case ''email'':
    		case ''phone_number'':
    		case ''rating'':
    		case ''duration'':
    		case ''password'':
    		case ''url'':
    			data[key] = typeof jDoc.variable.resp[key].value != "object" ? jDoc.variable.resp[key].value : JSON.stringify(jDoc.variable.resp[key].value);
    			break;
    		case ''single_select'':
    			if(isNaN(+jDoc.variable.resp[key].value)){
    				var search_id = obj.select_options.find((x)=>{
    					return x.value == jDoc.variable.resp[key].value;
    				})
    				if(search_id != null && search_id.id != null){
    					data[key] = search_id.id;
    				}
    				else{
    					data[key] = +jDoc.variable.resp[key].value;
    				}
    			}
    			else{
    				data[key] = +jDoc.variable.resp[key].value;
    			}
    			break;
    		case ''multiple_select'':
    			log.warn("** key: multiple_select TODO")
    			break;
    		case ''link_row'':
    			data[key] = jDoc.variable.resp[key].value.split('','').map(function(v) {
    				const trimmed = v.trim();
    				const num = Number(trimmed);
    				return isNaN(num) ? trimmed : num;
    			});
    			break;
    
    		case ''file'':
    			data[key] = [];  // will be filled further on  by the attachment loop.
    			break;
    				
    		case null:
    			if(forms_createColumn == "true"){
    				if(jDoc.variable.resp[key].type == "img" || jDoc.variable.resp[key].type == "file" || jDoc.variable.resp[key].type == "signature"){
    					columnToBeCreated.push({name: key, type: "file"});
    					data[key] = [];
    				}
    				else{
    					columnToBeCreated.push({name: key, type: "text"});
    					if(typeof jDoc.variable.resp[key] == "string"){
    						data[key] = jDoc.variable.resp[key];
    					}
    					else{
    						data[key] = typeof jDoc.variable.resp[key].value != "object" ? jDoc.variable.resp[key].value : JSON.stringify(jDoc.variable.resp[key].value);
    					}
    				}
    			}
    			else{
    				log.warn("** key: " + key + " doesn''t exists in target table")
    			}
    			break;
    		default: 
    			log.warn("** type: " + type + " is not yet handled")
    	}
    }
    
    var sjDoc = JSON.stringify(jDoc);
    
    '
↓jIterator [steps.SimpleIteratorStep-1680167384790]: 
  comment: Handle Attachements
  expression: Object.keys(jDoc.variable.resp)
  ↓jIf [steps.IfStep-1680167384793]: 
    comment: If From field type is an attachment (Photo)
    condition: jDoc.variable.resp[item].att_type === true
    ↓getAttachmentName [steps.SimpleStep-1680167384796]: 
      comment: Get the Attachement name and build a local file path to read the attachment from CouchDB
      expression: |
        '//imports 
        var File = java.io.File;
        // generic functions
        function makeid(length) {
            var result           = '''';
            var characters       = ''ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'';
            var charactersLength = characters.length;
            for ( var i = 0; i < length; i++ ) {
              result += characters.charAt(Math.floor(Math.random() * charactersLength));
           }
           return result;
        }
        
        function mkdir(parentDir, directoryName){
        	var directory = new File(parentDir, directoryName);
        	directory.mkdir()
        }
        
        var filesToDelete = [];
        var _use_attname = item;
        var _use_docid   = jDoc.variable._id;
        
        b64Value = "";
        var dirName = new Date().getTime() + "_" + makeid(20);
        var dir = context.getProjectDirectory()+"/attachments/";
        mkdir(dir, dirName);
        var _use_attpath = dir + dirName + "/"+ _use_attname;
        filesToDelete.push(_use_attpath)
        
        
        
        '
      output: true
    ↓Call_Transaction [steps.TransactionStep-1680167384799]: 
      comment: read the attachment in the workspace
      output: true
      sourceTransaction: lib_BaseRow.c8oforms_response_fs.GetDocumentAttachment
      ↓_use_attname [variables.StepVariable-1680167384802]: 
        description: Attachment name
      ↓_use_docid [variables.StepVariable-1680167384805]: 
        description: Document ID
      ↓_use_attpath [variables.StepVariable-1680167384808]: 
        description: Attachment path  This path is either absolute or relative to Convertigo environment. Relative paths starting with:<br/><br/>• <span class="computer">./</span> are relative to Convertigo workspace,<br/>• <span class="computer">.//</span> are relative to current project folder. <br/><br/>
    ↓jSimpleSource1 [steps.SimpleSourceStep-1680167384811]: 
      sourceDefinition: 
        - xmlizable: 
          - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
          - com.twinsoft.convertigo.beans.common.XMLVector: 
            - java.lang.String: 
              - ↑value: 1680167384799
            - java.lang.String: 
              - ↑value: ./document/couchdb_output/_c8oMeta/headers/Content_Type/text()
      variableName: contentType
    ↓reName [steps.SimpleStep-1747929146501]: 
      expression: |
        var File = java.io.File;
        
        var oldFilePath = "" + _use_attpath;
        
        _use_attpath = _use_attpath + "." + contentType.split("/")[1];
        
        var oldFile = new File(oldFilePath);
        var newFile = new File(_use_attpath);
        
        oldFile.renameTo(newFile)
    ↓element [steps.ElementStep-1680267486261]: 
      expression: _use_attpath
      nodeName: AttachmentPath
    ↓Call_Sequence [steps.SequenceStep-1680267245329]: 
      comment: Push it to BR
      sourceSequence: lib_BaseRow.TokenGetOrRefresh
    ↓Call_Transaction1 [steps.TransactionStep-1680267313862]: 
      sourceTransaction: lib_BaseRow.Baserow_API_spec._api_user_files_upload_file__POST
      ↓__header_Authorization [variables.StepVariable-1680267313865]: 
        sourceDefinition: 
          - xmlizable: 
            - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
            - com.twinsoft.convertigo.beans.common.XMLVector: 
              - java.lang.String: 
                - ↑value: 1680267245329
              - java.lang.String: 
                - ↑value: ./document/Bearer/text()
      ↓file [variables.StepVariable-1680267313868]: 
        sourceDefinition: 
          - xmlizable: 
            - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
            - com.twinsoft.convertigo.beans.common.XMLVector: 
              - java.lang.String: 
                - ↑value: 1680267486261
              - java.lang.String: 
                - ↑value: ./text()
    ↓delete_dir_andFiles [steps.SimpleStep-1747932814497]: 
      expression: |
        'var File = java.io.File;
        
        var directoryPath = dir + dirName ;
        
        var directory = new File(directoryPath);
        
        function deleteDirectory(directory) {
            if (!directory.exists()) {
                return;
            }
        
            var files = directory.listFiles();
        
            if (files != null) {
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    if (file.isDirectory()) {
                        deleteDirectory(file);
                    } else {
                        if (!file.delete()) {
                            log.warn("Échec de la suppression du fichier : " + file.getAbsolutePath());
                        }
                    }
                }
            }
        
            if (!directory.delete()) {
                log.warn("Échec de la suppression du dossier : " + directory.getAbsolutePath());
            } else {
                log.warn("Dossier supprimé avec succès : " + directory.getAbsolutePath());
            }
        }
        
        deleteDirectory(directory);
        '
    ↓jAttachmentName [steps.SimpleSourceStep-1680517771791]: 
      comment: Get the BR Attachment ID
      sourceDefinition: 
        - xmlizable: 
          - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
          - com.twinsoft.convertigo.beans.common.XMLVector: 
            - java.lang.String: 
              - ↑value: 1680267313862
            - java.lang.String: 
              - ↑value: ./document/object/name/text()
      variableName: jAttachmentName
    ↓AddAttachementToBRField [steps.SimpleStep-1680517961917]: 
      comment: Add this id to the data
      expression: |
        'data[_use_attname].push({
        	name: jAttachmentName
        });
        '
  ↓jIf1 [steps.IfStep-1680611569650]: 
    comment: If From field type is an uploaded file, can be an array of files
    condition: jDoc.variable.resp[item].type === 'file'
    ↓SaveItemToRespItem [steps.SimpleStep-1680612360876]: 
      expression: |
        let respItem = item;
        let respIndex = index;
        
        
    ↓jIterator [steps.SimpleIteratorStep-1680611652986]: 
      expression: jDoc.variable.resp[respItem].value
      ↓jIf [steps.IfStep-1748338956991]: 
        condition: item + '' != '[object Object]' && item != undefined && item != ''
        ↓getAttachmentName [steps.SimpleStep-1680611569653]: 
          comment: Get the Attachement name and build a local file path to read the attachment from CouchDB
          expression: |
            '//imports 
            var File = java.io.File;
            // generic functions
            function makeid(length) {
                var result           = '''';
                var characters       = ''ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'';
                var charactersLength = characters.length;
                for ( var i = 0; i < length; i++ ) {
                  result += characters.charAt(Math.floor(Math.random() * charactersLength));
               }
               return result;
            }
            
            function mkdir(parentDir, directoryName){
            	var directory = new File(parentDir, directoryName);
            	directory.mkdir()
            }
            
            var filesToDelete = [];
            var _use_attname = item;
            var _use_docid   = jDoc.variable._id;
            
            b64Value = "";
            var dirName = new Date().getTime() + "_" + makeid(20);
            var dir = context.getProjectDirectory()+"/attachments/";
            mkdir(dir, dirName);
            var _use_attpath = dir + dirName + "/" + _use_attname.split("_C80C80_")[1];
            filesToDelete.push(_use_attpath)
            
            
            
            '
          output: true
        ↓Call_Transaction [steps.TransactionStep-1680611569656]: 
          comment: read the attachment in the workspace
          output: true
          sourceTransaction: lib_BaseRow.c8oforms_response_fs.GetDocumentAttachment
          ↓_use_attname [variables.StepVariable-1680611569659]: 
            description: Attachment name
          ↓_use_docid [variables.StepVariable-1680611569662]: 
            description: Document ID
          ↓_use_attpath [variables.StepVariable-1680611569665]: 
            description: Attachment path  This path is either absolute or relative to Convertigo environment. Relative paths starting with:<br/><br/>• <span class="computer">./</span> are relative to Convertigo workspace,<br/>• <span class="computer">.//</span> are relative to current project folder. <br/><br/>
        ↓jSimpleSource1 [steps.SimpleSourceStep-1680611569668]: 
          sourceDefinition: 
            - xmlizable: 
              - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
              - com.twinsoft.convertigo.beans.common.XMLVector: 
                - java.lang.String: 
                  - ↑value: 1680611569656
                - java.lang.String: 
                  - ↑value: ./document/couchdb_output/_c8oMeta/headers/Content_Type/text()
          variableName: contentType
        ↓element [steps.ElementStep-1680611569671]: 
          expression: _use_attpath
          nodeName: AttachmentPath
        ↓Call_Sequence [steps.SequenceStep-1680611569674]: 
          comment: Push it to BR
          sourceSequence: lib_BaseRow.TokenGetOrRefresh
        ↓Call_Transaction1 [steps.TransactionStep-1680611569677]: 
          sourceTransaction: lib_BaseRow.Baserow_API_spec._api_user_files_upload_file__POST
          ↓__header_Authorization [variables.StepVariable-1680611569680]: 
            sourceDefinition: 
              - xmlizable: 
                - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
                - com.twinsoft.convertigo.beans.common.XMLVector: 
                  - java.lang.String: 
                    - ↑value: 1680611569674
                  - java.lang.String: 
                    - ↑value: ./document/Bearer/text()
          ↓file [variables.StepVariable-1680611569683]: 
            sourceDefinition: 
              - xmlizable: 
                - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
                - com.twinsoft.convertigo.beans.common.XMLVector: 
                  - java.lang.String: 
                    - ↑value: 1680611569671
                  - java.lang.String: 
                    - ↑value: ./text()
        ↓Delete_file [steps.DeleteStep-1680611569686]: 
          comment: Delete attachment from workspace as it has been uploaded
          sourcePath: filesToDelete[0]
        ↓jAttachmentName [steps.SimpleSourceStep-1680611569689]: 
          comment: Get the BR Attachment ID
          sourceDefinition: 
            - xmlizable: 
              - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
              - com.twinsoft.convertigo.beans.common.XMLVector: 
                - java.lang.String: 
                  - ↑value: 1680611569677
                - java.lang.String: 
                  - ↑value: ./document/object/name/text()
          variableName: jAttachmentName
        ↓AddAttachementToBRField [steps.SimpleStep-1680611569692]: 
          comment: Add this id to the data
          expression: |
            'data[jDoc.variable.resp[respItem].name].push({
            	name: jAttachmentName
            });
            '
↓StringifyData [steps.SimpleStep-1680526198273]: 
  expression: |
    data = JSON.stringify(data);
    
↓jIf1 [steps.IfStep-1734430788668]: 
  condition: forms_createColumn == "true" && columnToBeCreated.length > 0
  ↓jIterator [steps.SimpleIteratorStep-1734430886786]: 
    expression: columnToBeCreated
    ↓Sequence_JS [steps.SimpleStep-1734430925957]: 
      expression: |
        //todo
        var data = JSON.stringify(item);
    ↓Call_Sequence [steps.SequenceStep-1734431284662]: 
      output: true
      sourceSequence: lib_BaseRow.TableCreateColumn
      ↓table_id [variables.StepVariable-1734431301676]: 
        comment: Insert row in this table_id
        description: table_id
        required: true
      ↓data [variables.StepVariable-1734431301678]: 
        comment: A JSON object with each field name and value
        required: true
  ↓Call_Sequence1 [steps.SequenceStep-1734431536049]: 
    sourceSequence: lib_BaseRow.FieldsList
    ↓table_id [variables.StepVariable-1734431536052]: 
      comment: Returns only the fields of the table related to the provided value.
      description: table_id
      required: true
      value: 
  ↓jFields [steps.JsonSourceStep-1734431536055]: 
    comment: Get lits of fields and type from BR Table
    sourceDefinition: 
      - xmlizable: 
        - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
        - com.twinsoft.convertigo.beans.common.XMLVector: 
          - java.lang.String: 
            - ↑value: 1734431536049
          - java.lang.String: 
            - ↑value: ./document/array
    variableName: jFields
  ↓PrepareData [steps.SimpleStep-1734431536058]: 
    comment: Prepare data to submit according to BR field type
    expression: |
      '// convert XML to JSON doc
      var jDoc = JSON.parse('''' + com.twinsoft.convertigo.engine.util.XMLUtils.XmlToJson(doc, true, true));
      var columnToBeCreated = [];
      data = {}
      for (var key in jDoc.variable.resp) {
      	if(typeof jDoc.variable.resp[key].value != "string" && jDoc.variable.resp[key].value == null && jDoc.variable.resp[key].type != null){
      		switch(jDoc.variable.resp[key].type){
      			case "checkbox":
      				var children = jDoc.variable.resp[key].children;
      				var val = "";
      				for(var child of children){
      					if(child.selected){
      						val += child.value + ", "
      					}
      				}
      				if(val.length > 0){
      					val = val.substring(0, val.length -2);
      				}
      				jDoc.variable.resp[key].value = val;
      				break;
      		}
      	}
      	log.warn("** Key is : [" + key + "] value is : " + jDoc.variable.resp[key].value)
      	
      	let obj  = jFields.find((object) => object.name === key )
      	let type = obj ? obj.type : null
      	
      	log.warn("** type is : " + type)
      	switch (type) {
      		case ''text'':
      		case ''long_text'':
      		case ''number'':
      		case ''date'':
      		case ''boolean'':
      		case ''email'':
      		case ''phone_number'':
      		case ''rating'':
      		case ''duration'':
      		case ''password'':
      		case ''url'':
      			data[key] = typeof jDoc.variable.resp[key].value != "object" ? jDoc.variable.resp[key].value : JSON.stringify(jDoc.variable.resp[key].value);
      			break;
      		case ''single_select'':
      			if(isNaN(+jDoc.variable.resp[key].value)){
      				var search_id = obj.select_options.find((x)=>{
      					return x.value == jDoc.variable.resp[key].value;
      				})
      				if(search_id != null && search_id.id != null){
      					data[key] = search_id.id;
      				}
      				else{
      					data[key] = +jDoc.variable.resp[key].value;
      				}
      			}
      			else{
      				data[key] = +jDoc.variable.resp[key].value;
      			}
      			break;
      
      		case ''link_row'':
      			data[key] = jDoc.variable.resp[key].value.split('','').map(function(v) {
      				const trimmed = v.trim();
      				const num = Number(trimmed);
      				return isNaN(num) ? trimmed : num;
      			});
      			break;
      
      		case ''file'':
      			data[key] = [];  // will be filled further on  by the attachment loop.
      			break;
      				
      		case null:
      			if(forms_createColumn == "true"){
      				if(jDoc.variable.resp[key].type == "img" || jDoc.variable.resp[key].type == "file" || jDoc.variable.resp[key].type == "signature"){
      					columnToBeCreated.push({name: key, type: "file"});
      					data[key] = [];
      				}
      				else{
      					columnToBeCreated.push({name: key, type: "text"});
      					if(typeof jDoc.variable.resp[key] == "string"){
      						data[key] = jDoc.variable.resp[key];
      					}
      					else{
      						data[key] = typeof jDoc.variable.resp[key].value != "object" ? jDoc.variable.resp[key].value : JSON.stringify(jDoc.variable.resp[key].value);
      					}
      				}
      			}
      			else{
      				log.warn("** key: " + key + " doesn''t exists in target table")
      			}
      			break;
      		default: 
      			log.warn("** type: " + type + " is not yet handled")
      	}
      }
      var sjDoc = JSON.stringify(jDoc);
      '
  ↓jIterator2 [steps.SimpleIteratorStep-1748360671091]: 
    comment: Handle Attachements
    expression: Object.keys(jDoc.variable.resp)
    ↓jIf [steps.IfStep-1748360671094]: 
      comment: If From field type is an attachment (Photo)
      condition: jDoc.variable.resp[item].att_type === true
      ↓getAttachmentName [steps.SimpleStep-1748360671097]: 
        comment: Get the Attachement name and build a local file path to read the attachment from CouchDB
        expression: |
          '//imports 
          var File = java.io.File;
          // generic functions
          function makeid(length) {
              var result           = '''';
              var characters       = ''ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'';
              var charactersLength = characters.length;
              for ( var i = 0; i < length; i++ ) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
             }
             return result;
          }
          
          function mkdir(parentDir, directoryName){
          	var directory = new File(parentDir, directoryName);
          	directory.mkdir()
          }
          
          var filesToDelete = [];
          var _use_attname = item;
          var _use_docid   = jDoc.variable._id;
          
          b64Value = "";
          var dirName = new Date().getTime() + "_" + makeid(20);
          var dir = context.getProjectDirectory()+"/attachments/";
          mkdir(dir, dirName);
          var _use_attpath = dir + dirName + "/"+ _use_attname;
          filesToDelete.push(_use_attpath)
          
          
          
          '
        output: true
      ↓Call_Transaction [steps.TransactionStep-1748360671100]: 
        comment: read the attachment in the workspace
        output: true
        sourceTransaction: lib_BaseRow.c8oforms_response_fs.GetDocumentAttachment
        ↓_use_attname [variables.StepVariable-1748360671103]: 
          description: Attachment name
        ↓_use_docid [variables.StepVariable-1748360671106]: 
          description: Document ID
        ↓_use_attpath [variables.StepVariable-1748360671109]: 
          description: Attachment path  This path is either absolute or relative to Convertigo environment. Relative paths starting with:<br/><br/>• <span class="computer">./</span> are relative to Convertigo workspace,<br/>• <span class="computer">.//</span> are relative to current project folder. <br/><br/>
      ↓jSimpleSource1 [steps.SimpleSourceStep-1748360671112]: 
        sourceDefinition: 
          - xmlizable: 
            - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
            - com.twinsoft.convertigo.beans.common.XMLVector: 
              - java.lang.String: 
                - ↑value: 1748360671100
              - java.lang.String: 
                - ↑value: ./document/couchdb_output/_c8oMeta/headers/Content_Type/text()
        variableName: contentType
      ↓reName [steps.SimpleStep-1748360671115]: 
        expression: |
          var File = java.io.File;
          
          var oldFilePath = "" + _use_attpath;
          
          _use_attpath = _use_attpath + "." + contentType.split("/")[1];
          
          var oldFile = new File(oldFilePath);
          var newFile = new File(_use_attpath);
          
          oldFile.renameTo(newFile)
      ↓element [steps.ElementStep-1748360671118]: 
        expression: _use_attpath
        nodeName: AttachmentPath
      ↓Call_Sequence [steps.SequenceStep-1748360671121]: 
        comment: Push it to BR
        sourceSequence: lib_BaseRow.TokenGetOrRefresh
      ↓Call_Transaction1 [steps.TransactionStep-1748360671124]: 
        sourceTransaction: lib_BaseRow.Baserow_API_spec._api_user_files_upload_file__POST
        ↓__header_Authorization [variables.StepVariable-1748360671127]: 
          sourceDefinition: 
            - xmlizable: 
              - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
              - com.twinsoft.convertigo.beans.common.XMLVector: 
                - java.lang.String: 
                  - ↑value: 1748360671121
                - java.lang.String: 
                  - ↑value: ./document/Bearer/text()
        ↓file [variables.StepVariable-1748360671130]: 
          sourceDefinition: 
            - xmlizable: 
              - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
              - com.twinsoft.convertigo.beans.common.XMLVector: 
                - java.lang.String: 
                  - ↑value: 1748360671118
                - java.lang.String: 
                  - ↑value: ./text()
      ↓delete_dir_andFiles [steps.SimpleStep-1748360671133]: 
        expression: |
          'var File = java.io.File;
          
          var directoryPath = dir + dirName ;
          
          var directory = new File(directoryPath);
          
          function deleteDirectory(directory) {
              if (!directory.exists()) {
                  return;
              }
          
              var files = directory.listFiles();
          
              if (files != null) {
                  for (var i = 0; i < files.length; i++) {
                      var file = files[i];
                      if (file.isDirectory()) {
                          deleteDirectory(file);
                      } else {
                          if (!file.delete()) {
                              log.warn("Échec de la suppression du fichier : " + file.getAbsolutePath());
                          }
                      }
                  }
              }
          
              if (!directory.delete()) {
                  log.warn("Échec de la suppression du dossier : " + directory.getAbsolutePath());
              } else {
                  log.warn("Dossier supprimé avec succès : " + directory.getAbsolutePath());
              }
          }
          
          deleteDirectory(directory);
          '
      ↓Delete_file [steps.DeleteStep-1748360671136]: 
        comment: Delete attachment from workspace as it has been uploaded
        isEnabled: false
        sourcePath: filesToDelete[0]
      ↓jAttachmentName [steps.SimpleSourceStep-1748360671139]: 
        comment: Get the BR Attachment ID
        sourceDefinition: 
          - xmlizable: 
            - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
            - com.twinsoft.convertigo.beans.common.XMLVector: 
              - java.lang.String: 
                - ↑value: 1748360671124
              - java.lang.String: 
                - ↑value: ./document/object/name/text()
        variableName: jAttachmentName
      ↓AddAttachementToBRField [steps.SimpleStep-1748360671142]: 
        comment: Add this id to the data
        expression: |
          'data[_use_attname].push({
          	name: jAttachmentName
          });
          '
    ↓jIf1 [steps.IfStep-1748360671145]: 
      comment: If From field type is an uploaded file, can be an array of files
      condition: jDoc.variable.resp[item].type === 'file'
      ↓SaveItemToRespItem [steps.SimpleStep-1748360671148]: 
        expression: |
          let respItem = item;
          let respIndex = index;
          
          
      ↓jIterator [steps.SimpleIteratorStep-1748360671151]: 
        expression: jDoc.variable.resp[respItem].value
        ↓Sequence_JS [steps.SimpleStep-1748360671154]: 
          expression: var ty = typeof item;
        ↓jIf [steps.IfStep-1748360671157]: 
          condition: item + '' != '[object Object]' && item != undefined && item != ''
          ↓getAttachmentName [steps.SimpleStep-1748360671160]: 
            comment: Get the Attachement name and build a local file path to read the attachment from CouchDB
            expression: |
              '//imports 
              var File = java.io.File;
              // generic functions
              function makeid(length) {
                  var result           = '''';
                  var characters       = ''ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'';
                  var charactersLength = characters.length;
                  for ( var i = 0; i < length; i++ ) {
                    result += characters.charAt(Math.floor(Math.random() * charactersLength));
                 }
                 return result;
              }
              
              function mkdir(parentDir, directoryName){
              	var directory = new File(parentDir, directoryName);
              	directory.mkdir()
              }
              
              var filesToDelete = [];
              var _use_attname = item;
              var _use_docid   = jDoc.variable._id;
              
              b64Value = "";
              var dirName = new Date().getTime() + "_" + makeid(20);
              var dir = context.getProjectDirectory()+"/attachments/";
              mkdir(dir, dirName);
              var _use_attpath = dir + dirName + "/" + _use_attname.split("_C80C80_")[1];
              filesToDelete.push(_use_attpath)
              
              
              
              '
            output: true
          ↓Call_Transaction [steps.TransactionStep-1748360671163]: 
            comment: read the attachment in the workspace
            output: true
            sourceTransaction: lib_BaseRow.c8oforms_response_fs.GetDocumentAttachment
            ↓_use_attname [variables.StepVariable-1748360671166]: 
              description: Attachment name
            ↓_use_docid [variables.StepVariable-1748360671169]: 
              description: Document ID
            ↓_use_attpath [variables.StepVariable-1748360671172]: 
              description: Attachment path  This path is either absolute or relative to Convertigo environment. Relative paths starting with:<br/><br/>• <span class="computer">./</span> are relative to Convertigo workspace,<br/>• <span class="computer">.//</span> are relative to current project folder. <br/><br/>
          ↓jSimpleSource1 [steps.SimpleSourceStep-1748360671175]: 
            sourceDefinition: 
              - xmlizable: 
                - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
                - com.twinsoft.convertigo.beans.common.XMLVector: 
                  - java.lang.String: 
                    - ↑value: 1748360671163
                  - java.lang.String: 
                    - ↑value: ./document/couchdb_output/_c8oMeta/headers/Content_Type/text()
            variableName: contentType
          ↓element [steps.ElementStep-1748360671178]: 
            expression: _use_attpath
            nodeName: AttachmentPath
          ↓Call_Sequence [steps.SequenceStep-1748360671181]: 
            comment: Push it to BR
            sourceSequence: lib_BaseRow.TokenGetOrRefresh
          ↓Call_Transaction1 [steps.TransactionStep-1748360671184]: 
            sourceTransaction: lib_BaseRow.Baserow_API_spec._api_user_files_upload_file__POST
            ↓__header_Authorization [variables.StepVariable-1748360671187]: 
              sourceDefinition: 
                - xmlizable: 
                  - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
                  - com.twinsoft.convertigo.beans.common.XMLVector: 
                    - java.lang.String: 
                      - ↑value: 1748360671181
                    - java.lang.String: 
                      - ↑value: ./document/Bearer/text()
            ↓file [variables.StepVariable-1748360671190]: 
              sourceDefinition: 
                - xmlizable: 
                  - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
                  - com.twinsoft.convertigo.beans.common.XMLVector: 
                    - java.lang.String: 
                      - ↑value: 1748360671178
                    - java.lang.String: 
                      - ↑value: ./text()
          ↓Delete_file [steps.DeleteStep-1748360671193]: 
            comment: Delete attachment from workspace as it has been uploaded
            sourcePath: filesToDelete[0]
          ↓jAttachmentName [steps.SimpleSourceStep-1748360671196]: 
            comment: Get the BR Attachment ID
            sourceDefinition: 
              - xmlizable: 
                - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
                - com.twinsoft.convertigo.beans.common.XMLVector: 
                  - java.lang.String: 
                    - ↑value: 1748360671184
                  - java.lang.String: 
                    - ↑value: ./document/object/name/text()
            variableName: jAttachmentName
          ↓AddAttachementToBRField [steps.SimpleStep-1748360671199]: 
            comment: Add this id to the data
            expression: |
              'data[jDoc.variable.resp[respItem].name].push({
              	name: jAttachmentName
              });
              '
  ↓StringifyData [steps.SimpleStep-1734431536160]: 
    expression: |
      data = JSON.stringify(data);
      
↓jIfThenElse [steps.IfThenElseStep-1726213751006]: 
  condition: forms_id != '' && forms_id != null && forms_id != undefined
  ↓jThen [steps.ThenStep-1726213751008]: 
    ↓MakeRowID [steps.SimpleStep-1726214039657]: 
      expression: |
        row_id = forms_id
        
        
    ↓Call_Sequence [steps.SequenceStep-1726213836036]: 
      comment: Push the row to BR
      sourceSequence: lib_BaseRow.TableUpdateRow
      ↓table_id [variables.StepVariable-1726213898219]: 
        comment: Insert row in this table_id
        description: table_id
        required: true
      ↓row_id [variables.StepVariable-1726213898223]: 
        comment: Insert row in this table_id
        description: table_id
        required: true
      ↓data [variables.StepVariable-1726213898225]: 
    ↓IfExist [steps.IfExistStep-1726214087646]: 
      sourceDefinition: 
        - xmlizable: 
          - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
          - com.twinsoft.convertigo.beans.common.XMLVector: 
            - java.lang.String: 
              - ↑value: 1680078354205
            - java.lang.String: 
              - ↑value: ./document/error
      ↓Error_structure [steps.XMLErrorStep-1726214087652]: 
        message: 
          - xmlizable: 
            - ↑classname: com.twinsoft.convertigo.beans.steps.SmartType
            - SmartType: 
              - ↑mode: SOURCE
              - com.twinsoft.convertigo.beans.common.XMLVector: 
                - java.lang.String: 
                  - ↑value: 1680078354205
                - java.lang.String: 
                  - ↑value: ./document/error/message/text()
      ↓Return [steps.ReturnStep-1726214087655]: 
  ↓jElse [steps.ElseStep-1726213751010]: 
    ↓Call_Sequence [steps.SequenceStep-1680078354205]: 
      comment: Push the row to BR
      sourceSequence: lib_BaseRow.TableCreateRow
      ↓data [variables.StepVariable-1680078576091]: 
        comment: A JSON object with each field name and value
        required: true
        value: 
      ↓table_id [variables.StepVariable-1680078591586]: 
        comment: Insert row in this table_id
        description: table_id
        required: true
      ↓before [variables.StepVariable-1680078591588]: 
        comment: If provided then the newly created row will be positioned before the row with the provided id.
        description: before
    ↓IfExist [steps.IfExistStep-1680078354235]: 
      sourceDefinition: 
        - xmlizable: 
          - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
          - com.twinsoft.convertigo.beans.common.XMLVector: 
            - java.lang.String: 
              - ↑value: 1680078354205
            - java.lang.String: 
              - ↑value: ./document/error
      ↓Error_structure [steps.XMLErrorStep-1680078354238]: 
        message: 
          - xmlizable: 
            - ↑classname: com.twinsoft.convertigo.beans.steps.SmartType
            - SmartType: 
              - ↑mode: SOURCE
              - com.twinsoft.convertigo.beans.common.XMLVector: 
                - java.lang.String: 
                  - ↑value: 1680078354205
                - java.lang.String: 
                  - ↑value: ./document/error/message/text()
      ↓Return [steps.ReturnStep-1680078354241]: 
↓forms_config [variables.RequestableVariable-1680078354355]: 
  comment: |
    '{
        "en": {
            "comment": "Choose a table in the no-code database",
            "displayName": "Configuration"
        },
        "fr": {
            "comment": "Choisissez une table dans la no-code database",
            "displayName": "Configuration"
        },
        "es": {
            "comment": "Elija una tabla en la no-code database",
            "displayName": "Configuración"
        },
        "it": {
            "comment": "Scegli una tabella in il no-code database",
            "displayName": "Configurazione"
        }
    }'
  description: configure=lib_BaseRow/DisplayObjects/mobile/BrowseTables?noCols=true
  required: true
  value: 
↓doc [variables.RequestableVariable-1680085008489]: 
↓originalDoc [variables.RequestableVariable-1680078875207]: 
↓forms_id [variables.RequestableVariable-1726159331067]: 
  comment: |
    '{
        "en": {
            "comment": "The Identifier of the row to update. If not set, the action will add a row. If set, all row''s columns identified by the ''technicalID'' will be updated",
            "displayName": "Identifier"
        },
        "fr": {
            "comment": "L''identifiant de la ligne à mettre à jour. S''il n''est pas défini, l''action ajoutera une ligne. S''il est défini, toutes les colonnes de la ligne identifiées par l''ID technique seront mises à jour",
            "displayName": "Identifiant"
        },
        "es": {
            "comment": "El identificador de la fila a actualizar. Si no se establece, la acción agregará una fila. Si se establece, se actualizarán todas las columnas de la fila identificadas por el ''ID técnico''",
            "displayName": "Identificador"
        },
        "it": {
            "comment": "L''identificatore della riga da aggiornare. Se non impostato, l''azione aggiungerà una riga. Se impostato, tutte le colonne della riga identificate dal ''technicalID'' verranno aggiornate",
            "displayName": "Identificatore"
        }
    }'
↓forms_createColumn [variables.RequestableVariable-1734430377087]: 
  comment: |
    '{
        "en": {
            "comment": "Create a column if a field identifier does not match any column in the table",
            "displayName": "Columns creation"
        },
        "fr": {
            "comment": "Créer une colonne si un identifiant de champ ne correspond à aucune colonne dans le tableau",
            "displayName": "Création de colonnes"
        },
        "es": {
            "comment": "Crear una columna si un identificador de campo no coincide con ninguna columna en la tabla",
            "displayName": "Creación de columnas"
        },
        "it": {
            "comment": "Creare una colonna se un identificatore di campo non corrisponde a nessuna colonna nella tabella",
            "displayName": "Creazione di colonne"
        }
    }'
  description: boolean